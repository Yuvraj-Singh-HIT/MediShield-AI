<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Details - Climabot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;600;700;800&display=swap');
        
        :root {
            --primary-glow: #6366f1;
            --secondary-glow: #a855f7;
            --accent-glow: #ec4899;
            --cyber-blue: #00d4ff;
            --neon-green: #39ff14;
            --electric-purple: #bf00ff;
        }

        body {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            background: #000000;
            color: #ffffff;
            overflow-x: hidden;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Hide scrollbar but keep functionality */
        body::-webkit-scrollbar {
            display: none;
        }

        /* Advanced animated background */
        .cyber-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            background: 
                radial-gradient(circle at 15% 25%, rgba(0, 212, 255, 0.4) 0%, transparent 30%),
                radial-gradient(circle at 85% 75%, rgba(99, 102, 241, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 45% 60%, rgba(168, 85, 247, 0.3) 0%, transparent 35%),
                radial-gradient(circle at 10% 80%, rgba(57, 255, 20, 0.3) 0%, transparent 30%),
                linear-gradient(135deg, #000000 0%, #0d1117 25%, #161b22 50%, #0d1117 75%, #000000 100%);
            animation: cosmic-drift 30s ease-in-out infinite alternate;
        }

        @keyframes cosmic-drift {
            0% { transform: scale(1) rotate(0deg); filter: hue-rotate(0deg); }
            50% { transform: scale(1.05) rotate(0.5deg); filter: hue-rotate(180deg); }
            100% { transform: scale(1.02) rotate(-0.3deg); filter: hue-rotate(360deg); }
        }

        /* Floating shapes */
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
        }

        .shape {
            position: absolute;
            opacity: 0.08;
            filter: blur(1px);
        }

        .shape:nth-child(1) { 
            width: 100px; height: 100px;
            top: 20%; left: 10%;
            background: linear-gradient(45deg, var(--cyber-blue), var(--primary-glow));
            border-radius: 50%;
            animation: float-1 20s infinite linear;
        }

        .shape:nth-child(2) { 
            width: 60px; height: 60px;
            top: 70%; left: 80%;
            background: linear-gradient(135deg, var(--neon-green), var(--secondary-glow));
            transform: rotate(45deg);
            animation: float-2 25s infinite linear;
        }

        .shape:nth-child(3) { 
            width: 80px; height: 80px;
            top: 85%; left: 20%;
            background: linear-gradient(90deg, var(--accent-glow), var(--electric-purple));
            border-radius: 20px;
            animation: float-3 30s infinite linear;
        }

        @keyframes float-1 {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0.05; }
            50% { transform: translateY(-30vh) rotate(180deg); opacity: 0.12; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        @keyframes float-2 {
            0% { transform: translateY(0px) rotate(45deg); opacity: 0.06; }
            50% { transform: translateY(-35vh) rotate(225deg); opacity: 0.14; }
            100% { transform: translateY(-100vh) rotate(405deg); opacity: 0; }
        }

        @keyframes float-3 {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0.07; }
            50% { transform: translateY(-25vh) rotate(270deg); opacity: 0.13; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* Ultra-modern gradient text */
        .ultra-gradient {
            background: linear-gradient(135deg,
                #00d4ff 0%,
                #6366f1 25%,
                #a855f7 50%,
                #ec4899 75%,
                #39ff14 100%);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbow-shift 4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
        }

        @keyframes rainbow-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Quantum card design */
        .quantum-card {
            background: linear-gradient(135deg,
                rgba(0, 0, 0, 0.95) 0%,
                rgba(13, 17, 23, 0.9) 50%,
                rgba(0, 0, 0, 0.95) 100%);
            backdrop-filter: blur(30px) saturate(200%);
            border-radius: 2rem;
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.9),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                0 0 0 1px rgba(0, 212, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .quantum-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.3), transparent);
            transition: left 0.8s ease;
            z-index: 1;
        }

        .quantum-card:hover::before {
            left: 100%;
        }

        /* Weather cards */
        .weather-holo {
            background: linear-gradient(135deg,
                rgba(0, 0, 0, 0.85) 0%,
                rgba(21, 32, 43, 0.7) 50%,
                rgba(0, 0, 0, 0.85) 100%);
            backdrop-filter: blur(20px) saturate(200%);
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 1.5rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .weather-holo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                transparent,
                rgba(0, 212, 255, 0.1),
                transparent,
                rgba(57, 255, 20, 0.1),
                transparent);
            animation: hologram-rotate 8s linear infinite;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .weather-holo:hover::before {
            opacity: 1;
        }

        .weather-holo:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.9),
                0 0 40px rgba(0, 212, 255, 0.3);
            border-color: rgba(57, 255, 20, 0.6);
        }

        @keyframes hologram-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Holographic text effects */
        .holo-text {
            background: linear-gradient(135deg,
                rgba(0, 212, 255, 0.95) 0%,
                rgba(255, 255, 255, 1) 50%,
                rgba(57, 255, 20, 0.95) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5));
            animation: holo-shimmer 2s ease-in-out infinite alternate;
        }

        @keyframes holo-shimmer {
            0% { filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5)); }
            100% { filter: drop-shadow(0 0 20px rgba(57, 255, 20, 0.7)); }
        }

        /* Loading animation */
        .quantum-loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--neon-green);
            animation: quantum-spin 1s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(57, 255, 20, 0.8));
        }

        @keyframes quantum-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Smooth animations */
        .ultra-smooth {
            animation: ultra-fade-in 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes ultra-fade-in {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Weather icons */
        .weather-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 0 15px rgba(0, 212, 255, 0.6));
            animation: icon-float 3s ease-in-out infinite alternate;
            transition: all 0.3s ease;
        }

        .weather-icon:hover {
            transform: scale(1.1) rotate(5deg);
            filter: drop-shadow(0 0 20px rgba(57, 255, 20, 0.8));
        }

        @keyframes icon-float {
            0% { transform: translateY(0px) rotate(0deg); }
            100% { transform: translateY(-5px) rotate(2deg); }
        }

        /* Chart container */
        .chart-container {
            background: linear-gradient(135deg,
                rgba(0, 0, 0, 0.9) 0%,
                rgba(13, 17, 23, 0.8) 50%,
                rgba(0, 0, 0, 0.9) 100%);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        /* Hourly forecast scroll */
        .hourly-scroll {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 212, 255, 0.5) rgba(0, 0, 0, 0.3);
        }

        .hourly-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .hourly-scroll::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .hourly-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, var(--cyber-blue), var(--neon-green));
            border-radius: 3px;
        }

        /* AQI indicators */
        .aqi-good { border-color: rgba(34, 197, 94, 0.6); background: rgba(34, 197, 94, 0.1); }
        .aqi-moderate { border-color: rgba(251, 191, 36, 0.6); background: rgba(251, 191, 36, 0.1); }
        .aqi-unhealthy { border-color: rgba(239, 68, 68, 0.6); background: rgba(239, 68, 68, 0.1); }
        .aqi-hazardous { border-color: rgba(147, 51, 234, 0.6); background: rgba(147, 51, 234, 0.1); }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .weather-section { padding: 1rem; }
            .quantum-card { padding: 1.5rem; margin: 0.5rem; }
            .weather-holo { padding: 1rem; margin: 0.5rem 0; }
            .weather-icon { font-size: 2rem; }
        }

        /* Error states */
        .error-holo {
            background: rgba(220, 38, 38, 0.15);
            border: 2px solid rgba(220, 38, 38, 0.6);
            backdrop-filter: blur(15px);
            animation: error-pulse 2s ease-in-out infinite;
        }

        @keyframes error-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 40px rgba(220, 38, 38, 0.8); }
        }

        /* Holographic navbar */
        .holo-nav {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(25px) saturate(200%);
            border-bottom: 2px solid transparent;
            background-image: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)),
                              linear-gradient(90deg, var(--cyber-blue), var(--neon-green), var(--accent-glow));
            background-origin: border-box;
            background-clip: content-box, border-box;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            position: relative;
        }

        .holo-nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--cyber-blue) 50%, transparent 100%);
            animation: scan-line 3s ease-in-out infinite;
        }

        @keyframes scan-line {
            0%, 100% { opacity: 0; transform: scaleX(0); }
            50% { opacity: 1; transform: scaleX(1); }
        }

        /* Nav links */
        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            padding: 8px 0;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--cyber-blue), var(--neon-green));
            transition: all 0.3s ease;
            transform: translateX(-50%);
            border-radius: 1px;
        }

        .nav-link:hover::before {
            width: 100%;
        }

        .nav-link:hover {
            transform: translateY(-2px);
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="cyber-bg"></div>
 
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>
 
    <nav class="holo-nav py-6 px-6 md:px-13 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center space-x-4">
            <div class="logo-quantum">
                <svg width="50" height="50" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M36 20C36 16.6863 33.3137 14 30 14C29.3372 14 28.7142 14.1431 28.1538 14.4016C27.1507 12.0648 24.8082 10.5 22.08 10.5C18.6994 10.5 15.9 13.2994 15.9 16.68" fill="url(#quantumGradient1)"/>
                    <path d="M24 29L19 37H24L22.5 42L28.5 34H23L24 29Z" fill="url(#quantumGradient2)"/>
                    <circle cx="12" cy="15" r="1.5" fill="url(#quantumGradient3)" opacity="0.8"/>
                    <circle cx="38" cy="25" r="1" fill="url(#quantumGradient3)" opacity="0.6"/>
                    <defs>
                        <linearGradient id="quantumGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00d4ff;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="quantumGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#39ff14;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="quantumGradient3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#a855f7;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <span class="text-2xl font-black holo-text tracking-wider">CLIMABOT</span>
        </div>
        <div class="hidden md:flex space-x-8 pr-4">
            <a href="index.html" class="nav-link text-gray-300 hover:text-cyan-400 font-bold text-lg">HOME</a>
            <a href="weather.html" onclick="app.navigateToChat(); return false;" class="nav-link text-gray-300 hover:text-purple-400 font-bold text-lg">WEATHER</a>
            <a href="chatbot.html" onclick="app.navigateToChat(); return false;" class="nav-link text-gray-300 hover:text-purple-400 font-bold text-lg">CHATBOT</a>
            <a href="about.html" class="nav-link text-gray-300 hover:text-pink-400 font-bold text-lg">ABOUT</a>
            <a href="contact.html" class="nav-link text-gray-300 hover:text-blue-400 font-bold text-lg">CONTACT</a>
        </div>
        <button id="mobile-menu-btn" class="md:hidden text-gray-300 hover:text-cyan-400 focus:outline-none transition-all duration-300 transform hover:scale-110">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </nav>

    <main class="weather-results py-12 px-4 relative z-10">
        <div class="max-w-7xl mx-auto"> 
            <div class="text-center mb-12 ultra-smooth">
                <h1 class="text-5xl md:text-7xl font-black mb-4">
                    <span class="ultra-gradient" id="location-title">LOADING LOCATION...</span>
                </h1>
                <p class="text-xl text-gray-300 font-medium" id="current-time">
                    üìç Quantum Weather Analysis in Progress...
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                <div class="lg:col-span-2 quantum-card p-8 ultra-smooth">
                    <div class="flex flex-col lg:flex-row items-center justify-between">
                        <div class="text-center lg:text-left mb-6 lg:mb-0">
                            <div class="weather-icon text-8xl mb-4" id="main-weather-icon">‚ö°</div>
                            <h2 class="text-6xl font-black holo-text mb-2" id="main-temperature">--¬∞</h2>
                            <p class="text-2xl font-bold text-gray-300 mb-1" id="main-condition">Loading...</p>
                            <p class="text-lg text-gray-400" id="feels-like-temp">Feels like --¬∞</p>
                        </div>
                        <div class="grid grid-cols-2 gap-6 text-center">
                            <div class="weather-holo p-4">
                                <div class="text-cyan-400 text-sm font-bold mb-1">HUMIDITY</div>
                                <div class="text-2xl font-black holo-text" id="humidity-value">--%</div>
                            </div>
                            <div class="weather-holo p-4">
                                <div class="text-purple-400 text-sm font-bold mb-1">PRESSURE</div>
                                <div class="text-2xl font-black holo-text" id="pressure-value">-- hPa</div>
                            </div>
                            <div class="weather-holo p-4">
                                <div class="text-pink-400 text-sm font-bold mb-1">WIND</div>
                                <div class="text-2xl font-black holo-text" id="wind-value">-- km/h</div>
                            </div>
                            <div class="weather-holo p-4">
                                <div class="text-green-400 text-sm font-bold mb-1">VISIBILITY</div>
                                <div class="text-2xl font-black holo-text" id="visibility-value">-- km</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="quantum-card p-8 ultra-smooth">
                    <h3 class="text-2xl font-black holo-text mb-6 text-center">üåÖ SUN & MOON</h3>
                    <div class="space-y-6">
                        <div class="weather-holo p-4 text-center">
                            <div class="text-yellow-400 text-lg font-bold mb-2">‚òÄÔ∏è SUNRISE</div>
                            <div class="text-xl font-black text-gray-200" id="sunrise-time">--:--</div>
                            <div class="text-sm text-gray-400" id="sunrise-local">Local Time</div>
                        </div>
                        <div class="weather-holo p-4 text-center">
                            <div class="text-orange-400 text-lg font-bold mb-2">üåÖ SUNSET</div>
                            <div class="text-xl font-black text-gray-200" id="sunset-time">--:--</div>
                            <div class="text-sm text-gray-400" id="sunset-local">Local Time</div>
                        </div>
                        <div class="weather-holo p-4 text-center">
                            <div class="text-blue-400 text-lg font-bold mb-2">üåô MOON PHASE</div>
                            <div class="text-xl font-black text-gray-200" id="moon-phase">üåï</div>
                        </div>
                    </div>
                </div>
            </div>
 
            <div class="quantum-card p-8 mb-12 ultra-smooth">
                <h3 class="text-3xl font-black holo-text mb-8 text-center">‚è∞ 24-HOUR QUANTUM FORECAST</h3>
                <div class="hourly-scroll overflow-x-auto pb-4">
                    <div class="flex space-x-4 min-w-max" id="hourly-forecast">
                         Loading states 
                        <div class="weather-holo p-4 text-center min-w-[120px]">
                            <div class="quantum-loading mx-auto mb-3"></div>
                            <div class="text-sm text-gray-400">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="quantum-card p-8 mb-12 ultra-smooth">
                <h3 class="text-3xl font-black holo-text mb-8 text-center">üìÖ 7-DAY WEATHER TREND</h3>
                <div class="space-y-4" id="weekly-forecast">
                     Loading state 
                    <div class="weather-holo p-6 flex items-center justify-between">
                        <div class="quantum-loading"></div>
                        <div class="text-gray-400">Loading weekly forecast...</div>
                        <div class="quantum-loading"></div>
                    </div>
                </div>
            </div>

            <div class="quantum-card p-8 mb-12 ultra-smooth">
                <h3 class="text-3xl font-black holo-text mb-8 text-center">üå¨Ô∏è AIR QUALITY INDEX</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="weather-holo p-6 text-center" id="aqi-main">
                        <div class="text-cyan-400 text-lg font-bold mb-2">AQI INDEX</div>
                        <div class="text-4xl font-black holo-text mb-2" id="aqi-value">--</div>
                        <div class="text-sm font-bold" id="aqi-status">Loading...</div>
                    </div>
                    <div class="weather-holo p-6 text-center">
                        <div class="text-red-400 text-lg font-bold mb-2">PM2.5</div>
                        <div class="text-2xl font-black text-gray-200" id="pm25-value">-- Œºg/m¬≥</div>
                    </div>
                    <div class="weather-holo p-6 text-center">
                        <div class="text-yellow-400 text-lg font-bold mb-2">PM10</div>
                        <div class="text-2xl font-black text-gray-200" id="pm10-value">-- Œºg/m¬≥</div>
                    </div>
                    <div class="weather-holo p-6 text-center">
                        <div class="text-green-400 text-lg font-bold mb-2">O3</div>
                        <div class="text-2xl font-black text-gray-200" id="o3-value">-- Œºg/m¬≥</div>
                    </div>
                </div>
                <div class="mt-6 weather-holo p-4">
                    <div class="text-center text-gray-300" id="aqi-description">
                        Loading air quality analysis...
                    </div>
                </div>
            </div>

            <div id="error-container" class="hidden">
                <div class="error-holo p-8 rounded-2xl text-center">
                    <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-2xl font-bold text-red-400 mb-2">QUANTUM INTERFERENCE DETECTED</h3>
                    <p class="text-gray-300" id="error-message">Unable to fetch weather data. Please try again.</p>
                    <button onclick="location.reload()" class="mt-4 px-6 py-3 bg-red-600 hover:bg-red-700 rounded-xl font-bold transition-all">
                        üîÑ RETRY SCAN
                    </button>
                </div>
            </div>
        </div>
    </main>

<script>
    // Cache management
    const weatherCache = {
        get: (key) => {
            try {
                const cached = localStorage.getItem(`weather_cache_${key}`);
                if (cached) {
                    const data = JSON.parse(cached);
                    const now = Date.now();
                    // Cache expires after 30 minutes
                    if (now - data.timestamp < 1800000) {
                        return data.weather;
                    }
                    localStorage.removeItem(`weather_cache_${key}`);
                }
            } catch (e) {}
            return null;
        },
        set: (key, data) => {
            try {
                localStorage.setItem(`weather_cache_${key}`, JSON.stringify({
                    weather: data,
                    timestamp: Date.now()
                }));
            } catch (e) {}
        }
    };

    // Location management
    function getLocationFromSources() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLocation = urlParams.get('location') || urlParams.get('city');
        
        if (urlLocation) {
            return decodeURIComponent(urlLocation);
        }
        
        try {
            const savedWeatherData = localStorage.getItem('climabot_weather_data');
            if (savedWeatherData) {
                const weatherData = JSON.parse(savedWeatherData);
                const location = weatherData.location || weatherData.name;
                if (location) return location;
            }
            
            const directLocation = localStorage.getItem('searchedLocation') ||
                                 localStorage.getItem('climabot_location') ||
                                localStorage.getItem('weather_location') ||
                                localStorage.getItem('currentLocation');
            if (directLocation) return directLocation;
        } catch (error) {
            console.warn('localStorage error:', error);
        }
        
        if (typeof window.currentLocation !== 'undefined' && window.currentLocation) {
            return window.currentLocation;
        }
        
        return "London";
    }

    function storeCurrentLocation(locationName) {
        try {
            localStorage.setItem('currentLocation', locationName);
            sessionStorage.setItem('lastSearchedLocation', locationName);
            console.log('Stored current location:', locationName);
        } catch (error) {
            console.warn('Could not store location:', error);
        }
    }

    class WeatherDataFetcher {
        constructor(cityName) {
            this.city = cityName;
            this.lat = null;
            this.lon = null;
            this.cacheKey = cityName.toLowerCase().replace(/\s+/g, '_');
        }

        async getCoordinates() {
            try {
                // Check cache first
                const cachedData = weatherCache.get(this.cacheKey);
                if (cachedData) {
                    console.log('Using cached weather data for', this.city);
                    this.lat = cachedData.coord.lat;
                    this.lon = cachedData.coord.lon;
                    await this.updateCurrentWeather(cachedData);
                    return { lat: this.lat, lon: this.lon };
                }

                const response = await fetch(`/api/weather?q=${encodeURIComponent(this.city)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `City "${this.city}" not found`);
                }
                
                this.lat = data.coord.lat;
                this.lon = data.coord.lon;
                
                // Cache the data
                weatherCache.set(this.cacheKey, data);
                
                // Update UI immediately
                await this.updateCurrentWeather(data);
                
                return { lat: this.lat, lon: this.lon };
            } catch (error) {
                console.error('Error fetching coordinates:', error);
                throw error;
            }
        }

        async updateCurrentWeather(data) {
        // Update location title
        document.getElementById('location-title').textContent = `${data.name.toUpperCase()}`;
        
        // Calculate location's local time based on timezone offset
        const timezoneOffsetMinutes = Math.round(this.lon / 15) * 60; // Approximate timezone offset in minutes
        const utcNow = new Date();
        const locationTime = new Date(utcNow.getTime() + (timezoneOffsetMinutes * 60 * 1000));
        
        // Format the local time for that location
        const locationTimeString = locationTime.toLocaleString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true,
            timeZone: 'UTC' // We're already calculating the offset manually
        });
        
        // Update current time with location info
        document.getElementById('current-time').textContent = `üìç ${data.name}, ${locationTimeString}`;
        
        // Update main weather
        document.getElementById('main-weather-icon').textContent = this.getWeatherIcon(data.weather[0].main);
        document.getElementById('main-temperature').textContent = `${Math.round(data.main.temp)}¬∞C`;
        document.getElementById('main-condition').textContent = data.weather[0].description;
        document.getElementById('feels-like-temp').textContent = `Feels like ${Math.round(data.main.feels_like)}¬∞C`;
        
        // Update weather details
        document.getElementById('humidity-value').textContent = `${data.main.humidity}%`;
        document.getElementById('pressure-value').textContent = `${data.main.pressure} hPa`;
        document.getElementById('wind-value').textContent = `${Math.round(data.wind.speed * 3.6)} km/h`;
        document.getElementById('visibility-value').textContent = `${(data.visibility / 1000).toFixed(1)} km`;
    }

        async fetchHourlyForecast() {
            try {
                const cacheKey = `hourly_${this.cacheKey}`;
                const cached = weatherCache.get(cacheKey);
                
                if (cached) {
                    document.getElementById('hourly-forecast').innerHTML = cached;
                    return;
                }

                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${this.lat}&longitude=${this.lon}&hourly=temperature_2m,weather_code&timezone=auto&forecast_hours=24`
                );
                const data = await response.json();
                
                const hourlyHTML = data.hourly.time.slice(0, 8).map((time, index) => {
                    const localTime = new Date(time);
                    const hour = localTime.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    
                    const temp = Math.round(data.hourly.temperature_2m[index]);
                    const icon = this.getWeatherIconFromCode(data.hourly.weather_code[index]);
                    const condition = this.getWeatherConditionFromCode(data.hourly.weather_code[index]);
                    
                    return `
                        <div class="weather-holo p-4 text-center min-w-[120px] flex-shrink-0">
                            <div class="text-cyan-400 text-sm font-bold mb-2">${hour}</div>
                            <div class="weather-icon text-3xl mb-2">${icon}</div>
                            <div class="text-xl font-black holo-text mb-1">${temp}¬∞C</div>
                            <div class="text-xs text-gray-400">${condition}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('hourly-forecast').innerHTML = hourlyHTML;
                weatherCache.set(cacheKey, hourlyHTML);
            } catch (error) {
                console.error('Error fetching hourly forecast:', error);
            }
        }

        async fetchDailyForecast() {
            try {
                const cacheKey = `daily_${this.cacheKey}`;
                const cached = weatherCache.get(cacheKey);
                
                if (cached) {
                    document.getElementById('weekly-forecast').innerHTML = cached;
                    return;
                }

                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${this.lat}&longitude=${this.lon}&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&forecast_days=7`
                );
                const data = await response.json();
                
                const dailyHTML = data.daily.time.map((date, index) => {
                    const dayName = new Date(date).toLocaleDateString('en-US', {weekday: 'long', month: 'short', day: 'numeric'});
                    const maxTemp = Math.round(data.daily.temperature_2m_max[index]);
                    const minTemp = Math.round(data.daily.temperature_2m_min[index]);
                    const icon = this.getWeatherIconFromCode(data.daily.weather_code[index]);
                    const condition = this.getWeatherConditionFromCode(data.daily.weather_code[index]);
                    
                    return `
                        <div class="weather-holo p-6 flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="weather-icon text-3xl">${icon}</div>
                                <div>
                                    <div class="text-lg font-bold text-gray-200">${dayName}</div>
                                    <div class="text-sm text-gray-400">${condition}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black holo-text">${maxTemp}¬∞ / ${minTemp}¬∞</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('weekly-forecast').innerHTML = dailyHTML;
                weatherCache.set(cacheKey, dailyHTML);
            } catch (error) {
                console.error('Error fetching daily forecast:', error);
            }
        }

        // COMPLETELY REWRITTEN: Simple and reliable sunrise/sunset fetching
        async fetchSunTimes() {
            try {
                const cacheKey = `sun_times_${this.cacheKey}`;
                const cached = weatherCache.get(cacheKey);
                
                if (cached) {
                    this.updateSunTimesUI(cached);
                    return;
                }

                console.log(`Fetching sun times for ${this.city} at coordinates: ${this.lat}, ${this.lon}`);

                // Method 1: Try Open-Meteo API (most reliable for local times)
                let sunData = await this.fetchSunTimesFromOpenMeteo();

                if (sunData) {
                    // Cache the data
                    weatherCache.set(cacheKey, sunData);
                    // Update UI
                    this.updateSunTimesUI(sunData);
                    console.log(`‚úÖ Sun times successfully fetched for ${this.city}:`, sunData);
                } else {
                    throw new Error('All sun time APIs failed');
                }
                
            } catch (error) {
                console.error('‚ùå Error fetching sun times:', error);
                // Show error state
                document.getElementById('sunrise-time').textContent = 'Unavailable';
                document.getElementById('sunset-time').textContent = 'Unavailable';
                document.getElementById('sunrise-local').textContent = 'Service Error';
                document.getElementById('sunset-local').textContent = 'Service Error';
                document.getElementById('moon-phase').textContent = 'üåô';
            }
        }

        // Method 1: Open-Meteo API (handles timezone automatically)
        async fetchSunTimesFromOpenMeteo() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${this.lat}&longitude=${this.lon}&daily=sunrise,sunset&timezone=auto&start_date=${today}&end_date=${today}`,
                    { 
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Open-Meteo API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.daily || !data.daily.sunrise || !data.daily.sunset) {
                    throw new Error('Invalid Open-Meteo response format');
                }

                const sunriseTime = new Date(data.daily.sunrise[0]);
                const sunsetTime = new Date(data.daily.sunset[0]);
                const moonPhase = this.calculateMoonPhase(new Date());

                return {
                    sunrise: {
                        formatted: sunriseTime.toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        })
                    },
                    sunset: {
                        formatted: sunsetTime.toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        })
                    },
                    moonPhase: moonPhase,
                    source: 'Open-Meteo API',
                    timezone: data.timezone || 'Local Time'
                };
            } catch (error) {
                console.warn('Open-Meteo API failed:', error.message);
                return null;
            }
        }

        // Helper method to convert 24-hour to 12-hour format
        convertTo12Hour(timeString) {
            try {
                // Handle different time formats
                let time = timeString;
                
                // If it's already in 12-hour format, return as is
                if (time.includes('AM') || time.includes('PM')) {
                    return time;
                }
                
                // Parse 24-hour format
                const [hours, minutes] = time.split(':');
                const hour24 = parseInt(hours);
                const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
                const ampm = hour24 >= 12 ? 'PM' : 'AM';
                
                return `${hour12}:${minutes} ${ampm}`;
            } catch (error) {
                console.warn('Time conversion error:', error);
                return timeString; // Return original if conversion fails
            }
        }

        // Helper method to update the sun times UI
        updateSunTimesUI(sunData) {
            document.getElementById('sunrise-time').textContent = sunData.sunrise.formatted;
            document.getElementById('sunset-time').textContent = sunData.sunset.formatted;
            document.getElementById('sunrise-local').textContent = sunData.timezone || 'Local Time';
            document.getElementById('sunset-local').textContent = sunData.timezone || 'Local Time';
            document.getElementById('moon-phase').textContent = sunData.moonPhase.emoji;
            
            console.log(`üåÖ UI Updated - Sunrise: ${sunData.sunrise.formatted}, Sunset: ${sunData.sunset.formatted} (${sunData.source})`);
        }

        // Helper method to calculate moon phase
        calculateMoonPhase(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            // Simplified moon phase calculation
            const c = Math.floor(year / 100);
            const e = 2 * (year - c * 100);
            const f = Math.floor(c / 4);
            
            let jd = 365.25 * year + 30.6001 * (month + 1) + day + f + 2 - c;
            
            // Days since known new moon (Jan 6, 2000)
            const daysSinceNewMoon = jd - 2451549.5;
            
            // Moon cycle is approximately 29.53 days
            const moonCycle = 29.530588853;
            const phase = (daysSinceNewMoon % moonCycle) / moonCycle;
            
            if (phase < 0.03 || phase > 0.97) {
                return { name: 'New Moon', emoji: 'üåë' };
            } else if (phase < 0.22) {
                return { name: 'Waxing Crescent', emoji: 'üåí' };
            } else if (phase < 0.28) {
                return { name: 'First Quarter', emoji: 'üåì' };
            } else if (phase < 0.47) {
                return { name: 'Waxing Gibbous', emoji: 'üåî' };
            } else if (phase < 0.53) {
                return { name: 'Full Moon', emoji: 'üåï' };
            } else if (phase < 0.72) {
                return { name: 'Waning Gibbous', emoji: 'üåñ' };
            } else if (phase < 0.78) {
                return { name: 'Last Quarter', emoji: 'üåó' };
            } else {
                return { name: 'Waning Crescent', emoji: 'üåò' };
            }
        }

        async fetchAirQuality() {
            try {
                const response = await fetch(`/api/air-quality?lat=${this.lat}&lon=${this.lon}`);
                if (!response.ok) throw new Error('AQI not available');
                
                const data = await response.json();
                const current = data.list[0];
                const components = current.components;
                const aqi = current.main.aqi;
                
                document.getElementById('aqi-value').textContent = aqi;
                document.getElementById('aqi-status').textContent = this.getAQIStatus(aqi);
                document.getElementById('pm25-value').textContent = `${Math.round(components.pm2_5 || 0)} Œºg/m¬≥`;
                document.getElementById('pm10-value').textContent = `${Math.round(components.pm10 || 0)} Œºg/m¬≥`;
                document.getElementById('o3-value').textContent = `${Math.round(components.o3 || 0)} Œºg/m¬≥`;
                document.getElementById('aqi-description').textContent = this.getAQIDescription(aqi);
                
                // Update AQI card styling
                const aqiCard = document.getElementById('aqi-main');
                aqiCard.className = `weather-holo p-6 text-center aqi-${this.getAQIClass(aqi)}`;
            } catch (error) {
                console.error('Error fetching air quality:', error);
                document.getElementById('aqi-value').textContent = 'N/A';
                document.getElementById('aqi-status').textContent = 'UNKNOWN';
                document.getElementById('aqi-description').textContent = 'Air quality data not available';
            }
        }

        // Helper methods
        getWeatherIcon(condition) {
            const iconMap = {
                'Clear': '‚òÄÔ∏è', 'Clouds': '‚òÅÔ∏è', 'Rain': 'üåßÔ∏è', 'Drizzle': 'üå¶Ô∏è',
                'Thunderstorm': '‚õàÔ∏è', 'Snow': '‚ùÑÔ∏è', 'Mist': 'üå´Ô∏è', 'Fog': 'üå´Ô∏è'
            };
            return iconMap[condition] || '‚òÅÔ∏è';
        }

        getWeatherIconFromCode(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code >= 1 && code <= 3) return '‚òÅÔ∏è';
            if (code >= 45 && code <= 48) return 'üå´Ô∏è';
            if (code >= 51 && code <= 55) return 'üå¶Ô∏è';
            if (code >= 61 && code <= 65) return 'üåßÔ∏è';
            if (code >= 71 && code <= 75) return '‚ùÑÔ∏è';
            if (code >= 95) return '‚õàÔ∏è';
            return '‚òÅÔ∏è';
        }

        getWeatherConditionFromCode(code) {
            const conditionMap = {
                0: 'Clear', 1: 'Mostly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                45: 'Fog', 51: 'Light Drizzle', 61: 'Light Rain', 71: 'Light Snow', 95: 'Thunderstorm'
            };
            return conditionMap[code] || 'Unknown';
        }

        getAQIStatus(aqi) {
            const statuses = { 1: 'GOOD', 2: 'FAIR', 3: 'MODERATE', 4: 'POOR', 5: 'VERY POOR' };
            return statuses[aqi] || 'UNKNOWN';
        }

        getAQIClass(aqi) {
            const classes = { 1: 'good', 2: 'good', 3: 'moderate', 4: 'unhealthy', 5: 'hazardous' };
            return classes[aqi] || 'moderate';
        }

        getAQIDescription(aqi) {
            const descriptions = {
                1: 'Air quality is excellent for outdoor activities.',
                2: 'Air quality is good for most outdoor activities.',
                3: 'Air quality is moderate. Sensitive individuals should limit exposure.',
                4: 'Air quality is poor. Everyone should limit outdoor activities.',
                5: 'Air quality is hazardous. Avoid outdoor activities.'
            };
            return descriptions[aqi] || 'Air quality information not available.';
        }

        async fetchAllWeatherData() {
            try {
                console.log(`üåç Fetching weather data for ${this.city}...`);
                
                // Get coordinates and update current weather (uses cache if available)
                await this.getCoordinates();
                
                // Store the location
                storeCurrentLocation(this.city);
                
                // Fetch additional data in parallel (uses cache where available)
                Promise.all([
                    this.fetchHourlyForecast(),
                    this.fetchDailyForecast(),
                    this.fetchSunTimes(),
                    this.fetchAirQuality()
                ]).catch(error => {
                    console.warn('Some weather data could not be fetched:', error);
                });
                
            } catch (error) {
                console.error('Error fetching weather data:', error);
                this.showError(error.message);
            }
        }

        showError(message) {
            document.getElementById('location-title').textContent = 'ERROR LOADING WEATHER';
            document.getElementById('current-time').textContent = `‚ö†Ô∏è ${message}`;
            document.getElementById('error-container').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }
    }

    // Initialize weather app
    async function initWeatherApp() {
        const city = getLocationFromSources();
        const weatherFetcher = new WeatherDataFetcher(city);
        
        try {
            await weatherFetcher.fetchAllWeatherData();
            console.log('‚úÖ Weather app initialized successfully!');
        } catch (error) {
            console.error('‚ùå Failed to initialize weather app:', error);
            weatherFetcher.showError(error.message || 'Failed to load weather data');
        }
    }

    // Auto-initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWeatherApp);
    } else {
        initWeatherApp();
    }
</script>
</body>
</html>
